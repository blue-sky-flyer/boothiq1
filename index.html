<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BoothIQ - Professional Booth Estimation</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #f9fafb; line-height: 1.5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .card { background: white; border-radius: 8px; padding: 40px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .header { margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }
    .header h1 { color: #1f2937; font-size: 32px; margin-bottom: 10px; }
    .header p { color: #6b7280; font-size: 16px; }
    .form-group { margin-bottom: 30px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
    select, input[type="number"] { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
    input[type="range"] { width: 100%; height: 6px; }
    .dimensions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .toggle-group { display: flex; gap: 10px; }
    .toggle-btn { padding: 10px 16px; border: 2px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer; font-size: 14px; font-weight: 500; color: #374151; transition: all 0.2s; }
    .toggle-btn:hover { border-color: #9ca3af; }
    .toggle-btn.active { border-color: #2563eb; background: #eff6ff; color: #2563eb; font-weight: 600; }
    .duration-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .three-state-toggle { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .three-state-toggle .toggle-btn { width: 100%; padding: 10px; }
    .upload-zone { border: 2px dashed #d1d5db; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; background: #fafafa; transition: all 0.2s; }
    .upload-zone:hover { background: #f3f4f6; border-color: #9ca3af; }
    .upload-zone.dragging { background: #f0f0f0; border-color: #2563eb; }
    .upload-zone p { margin: 0; color: #6b7280; }
    .upload-zone p:first-child { font-weight: 500; color: #374151; margin-bottom: 8px; }
    .error { background: #fee2e2; border: 1px solid #fca5a5; border-radius: 6px; padding: 12px; margin-bottom: 20px; color: #991b1b; }
    .loading { text-align: center; padding: 40px; }
    .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid #e5e7eb; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .estimates-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
    .estimate-card { border: 2px solid; border-radius: 8px; padding: 20px; }
    .estimate-card.aggressive { border-color: #991b1b; background: #fee2e2; }
    .estimate-card.middle { border-color: #92400e; background: #fef3c7; }
    .estimate-card.conservative { border-color: #0c2d6b; background: #dbeafe; }
    .estimate-card h3 { margin-bottom: 15px; font-size: 16px; font-weight: 600; border-bottom: 2px solid; padding-bottom: 10px; }
    .estimate-card.aggressive h3 { color: #991b1b; border-bottom-color: #991b1b; }
    .estimate-card.middle h3 { color: #92400e; border-bottom-color: #92400e; }
    .estimate-card.conservative h3 { color: #0c2d6b; border-bottom-color: #0c2d6b; }
    .line-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 14px; }
    .line-item-label { color: #374151; }
    .line-item-amount { font-weight: 600; color: #1f2937; }
    .total-line { display: flex; justify-content: space-between; padding: 12px 0; border-top: 2px solid; margin-top: 10px; font-size: 18px; font-weight: bold; }
    .estimate-card.aggressive .total-line { border-top-color: #991b1b; color: #991b1b; }
    .estimate-card.middle .total-line { border-top-color: #92400e; color: #92400e; }
    .estimate-card.conservative .total-line { border-top-color: #0c2d6b; color: #0c2d6b; }
    .btn { width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .btn:hover { background: #1d4ed8; }
    .divider { padding-bottom: 30px; margin-bottom: 30px; border-bottom: 1px solid #e5e7eb; }
    .preview-img { max-width: 100%; border-radius: 6px; max-height: 300px; margin: 15px 0; }
    .pdf-badge { display: inline-flex; align-items: center; gap: 10px; padding: 12px; background: #f3f4f6; border-radius: 6px; color: #374151; margin: 15px 0; }
    .empty-state { text-align: center; color: #9ca3af; padding: 40px; }
    .section-title { font-size: 14px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 20px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .btn-ai { background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); margin-top: 20px; }
    .btn-ai:hover { background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%); }
    .btn-ai:disabled { background: #9ca3af; cursor: not-allowed; }
    .ai-quote-section { margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border: 2px solid #8b5cf6; border-radius: 12px; }
    .ai-quote-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .ai-quote-header h3 { color: #5b21b6; margin: 0; font-size: 18px; }
    .ai-badge { background: #8b5cf6; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .ai-quote-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .ai-quote-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .ai-quote-card h4 { margin: 0 0 12px 0; color: #374151; font-size: 14px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; }
    .ai-line-item { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; }
    .ai-line-item.subtotal { border-top: 1px solid #e5e7eb; margin-top: 8px; padding-top: 8px; font-weight: 600; }
    .ai-total-section { grid-column: 1 / -1; background: white; border-radius: 8px; padding: 20px; text-align: center; }
    .ai-total { font-size: 36px; font-weight: 700; color: #5b21b6; }
    .ai-confidence { margin-top: 10px; font-size: 14px; }
    .ai-confidence.high { color: #059669; }
    .ai-confidence.medium { color: #d97706; }
    .ai-confidence.low { color: #dc2626; }
    .ai-notes { grid-column: 1 / -1; background: #fefce8; border: 1px solid #fde047; border-radius: 8px; padding: 15px; font-size: 13px; }
    .ai-notes h4 { margin: 0 0 10px 0; color: #854d0e; }
    .ai-notes ul { margin: 0; padding-left: 20px; color: #713f12; }
    @media (max-width: 768px) { .ai-quote-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // PDF.js is optional - app works without it (just no PDF upload)
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.js';
    }

    // Cloudflare Worker URLs - handle API keys and SKILL.md server-side
    const CLAUDE_WORKER_URL = 'https://boothiq-proxy.raj-lucia001.workers.dev';
    const GEMINI_WORKER_URL = 'https://boothiq-gemini.raj-lucia001.workers.dev'; // Deploy with: wrangler deploy -c wrangler-gemini.toml

    const DURATION_OPTIONS = [1, 3, 7, 30];

    const CATALOG_PRICING = {
      walls: {
        paintedMDF: 68.75,
        oakWood: 103.13,
        complexMillwork: 157.78,
      },
      flooring: {
        standardCarpet: 5.50,
        printedVinyl: 14.30,
        gFloorNew: 27.27,
        astroTurf: 16.92
      }
    };

    function BoothIQ() {
      const [location, setLocation] = React.useState('toronto');
      const [width, setWidth] = React.useState(10);
      const [length, setLength] = React.useState(10);
      const [indoor, setIndoor] = React.useState(true);
      const [duration, setDuration] = React.useState(3);
      const [groundLevel, setGroundLevel] = React.useState('not-sure');
      const [components, setComponents] = React.useState(null);
      const [estimates, setEstimates] = React.useState(null);
      const [uploadedImage, setUploadedImage] = React.useState(null);
      const [uploadedPDF, setUploadedPDF] = React.useState(null);
      const [pdfText, setPdfText] = React.useState('');
      const [analyzing, setAnalyzing] = React.useState(false);
      const [error, setError] = React.useState('');
      const fileInputRef = React.useRef(null);
      const [dragging, setDragging] = React.useState(false);
      const [aiQuote, setAiQuote] = React.useState(null);
      const [loadingAiQuote, setLoadingAiQuote] = React.useState(false);

      const calculateBoothSpecs = () => {
        const w = parseFloat(width) || 0;
        const l = parseFloat(length) || 0;
        
        // Calculate wall sqft (perimeter √ó 10ft height assumed)
        const perimeter = (w + l) * 2;
        const wallSqft = perimeter * 10;
        const floorSqft = w * l;

        return {
          wallSqft,
          floorSqft,
          wallType: 'paintedMDF',
          floorType: 'standardCarpet',
          graphics: 'moderate'
        };
      };

      const extractPdfText = async (file) => {
        if (typeof pdfjsLib === 'undefined') {
          throw new Error('PDF support unavailable - try disabling ad blocker or upload an image instead');
        }
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          let fullText = '';

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map((item) => item.str).join(' ');
            fullText += pageText + '\n';
          }

          return fullText;
        } catch (err) {
          throw new Error('Failed to extract PDF text: ' + err.message);
        }
      };

      const calculateMaterials = (comps) => {
        let cost = 0;
        cost += (comps.wallSqft || 0) * (CATALOG_PRICING.walls[comps.wallType] || 68.75);
        const floorPrices = {
          standardCarpet: 5.50,
          printedVinyl: 14.30,
          gFloorNew: 27.27,
          astroTurf: 16.92
        };
        cost += (comps.floorSqft || 0) * (floorPrices[comps.floorType] || 5.50);
        
        const graphicsPrices = { modest: 12, moderate: 25, premium: 45, extensive: 60 };
        cost += (comps.graphicsEstimate || 100) * (graphicsPrices[comps.graphics] || 25);
        
        return cost;
      };

      const calculateEstimates = (comps, loc, dur, env, ground) => {
        const materials = calculateMaterials(comps);
        const subtotal = materials;
        
        const serviceRates = {
          toronto: { designPM: 0.09, installDismantle: 0.14, logistics: 0.05 },
          montreal: { designPM: 0.12, installDismantle: 0.36, logistics: 0.12 },
          usa: { designPM: 0.10, installDismantle: 0.20, logistics: 0.15 }
        };

        const rates = serviceRates[loc] || serviceRates.toronto;
        
        // Duration multiplier: longer use = lower per-day cost
        const durationMultipliers = {
          1: 1.0,
          3: 0.82,
          7: 0.60,
          30: 0.65
        };
        const durationMult = durationMultipliers[dur] || 0.95;

        // Outdoor multiplier (outdoor = more setup/breakdown labor)
        const outdoorMult = env === 'outdoor' ? 1.15 : 1.0;

        // Ground level multiplier (uneven = more labor)
        const groundMultiplier = ground === 'no' ? 1.20 : ground === 'yes' ? 1.0 : 1.08;
        
        const estimates = {
          aggressive: {
            materials: materials * 0.85,
            designPM: subtotal * rates.designPM * 0.85 * durationMult * outdoorMult,
            installDismantle: subtotal * rates.installDismantle * 0.80 * outdoorMult * groundMultiplier,
            logistics: subtotal * rates.logistics * 0.90 * durationMult,
            contingency: 0
          },
          middle: {
            materials: materials,
            designPM: subtotal * rates.designPM * durationMult * outdoorMult,
            installDismantle: subtotal * rates.installDismantle * outdoorMult * groundMultiplier,
            logistics: subtotal * rates.logistics * durationMult,
            contingency: subtotal * 0.05
          },
          conservative: {
            materials: materials * 1.20,
            designPM: subtotal * rates.designPM * 1.15 * durationMult * outdoorMult,
            installDismantle: subtotal * rates.installDismantle * 1.20 * outdoorMult * groundMultiplier,
            logistics: subtotal * rates.logistics * 1.15 * durationMult,
            contingency: subtotal * 0.15
          }
        };

        return Object.entries(estimates).reduce((acc, [tier, costs]) => {
          acc[tier] = {
            ...costs,
            total: Object.values(costs).reduce((sum, val) => sum + val, 0)
          };
          return acc;
        }, {});
      };

      const updateEstimates = (newComps = null) => {
        const specs = newComps || calculateBoothSpecs();
        setComponents(specs);
        const calcs = calculateEstimates(specs, location, duration, indoor ? 'indoor' : 'outdoor', groundLevel);
        setEstimates(calcs);
      };

      React.useEffect(() => {
        updateEstimates();
      }, [location, width, length, indoor, duration, groundLevel]);

      const analyzeWithClaude = async (imageBase64 = null, pdfTextContent = '') => {
        try {
          let promptText = '';

          if (pdfTextContent && imageBase64) {
            promptText = `You have a booth rendering image and the following PDF parts list. Combine both to extract component details.\n\nPDF Content:\n${pdfTextContent}\n\nReturn ONLY valid JSON: {wallSqft: number, floorSqft: number, wallType: "paintedMDF"|"oakWood"|"complexMillwork", floorType: "standardCarpet"|"printedVinyl"|"gFloorNew"|"astroTurf", graphics: "modest"|"moderate"|"premium"|"extensive", graphicsEstimate: number}. No markdown, no explanation.`;
          } else if (pdfTextContent) {
            promptText = `Extract booth component details from this parts list PDF text.\n\nPDF Content:\n${pdfTextContent}\n\nReturn ONLY valid JSON: {wallSqft: number, floorSqft: number, wallType: "paintedMDF"|"oakWood"|"complexMillwork", floorType: "standardCarpet"|"printedVinyl"|"gFloorNew"|"astroTurf", graphics: "modest"|"moderate"|"premium"|"extensive", graphicsEstimate: number}. No markdown, no explanation.`;
          } else if (imageBase64) {
            promptText = 'Analyze booth rendering and return JSON: {wallSqft: number, floorSqft: number, wallType: "paintedMDF"|"oakWood"|"complexMillwork", floorType: "standardCarpet"|"printedVinyl"|"gFloorNew"|"astroTurf", graphics: "modest"|"moderate"|"premium"|"extensive", graphicsEstimate: number}. Return ONLY valid JSON, no markdown or explanation.';
          }

          // Route through Cloudflare Worker (handles API key server-side)
          const response = await fetch(CLAUDE_WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: [{
                role: 'user',
                content: promptText
              }]
            })
          });

          if (!response.ok) throw new Error('Worker API failed');
          const data = await response.json();
          console.log('Claude analysis:', data.content[0].text);
          return JSON.parse(data.content[0].text);
        } catch (err) {
          throw new Error('Analysis failed: ' + err.message);
        }
      };

      // Get structured AI quote from Gemini
      const getAIQuote = async () => {
        setError('');
        setLoadingAiQuote(true);
        setAiQuote(null);

        try {
          // Build the prompt with all current specs
          const specs = {
            width: parseFloat(width) || 10,
            length: parseFloat(length) || 10,
            location: location,
            environment: indoor ? 'indoor' : 'outdoor',
            duration: duration,
            groundLevel: groundLevel,
            uploadedPdf: uploadedPDF || null,
            pdfContent: pdfText || null
          };

          let promptText = `Generate a detailed booth quote for:
- Dimensions: ${specs.width}ft √ó ${specs.length}ft (${specs.width * specs.length} sq ft)
- Location: ${specs.location}
- Environment: ${specs.environment}
- Duration: ${specs.duration} days
- Ground Level: ${specs.groundLevel === 'yes' ? 'Yes (level floor)' : specs.groundLevel === 'no' ? 'No (uneven, requires leveling)' : 'Unknown'}`;

          if (specs.pdfContent) {
            promptText += `\n\nAdditional context from uploaded PDF:\n${specs.pdfContent.substring(0, 2000)}`;
          }

          promptText += `\n\nProvide a complete quote with materials breakdown, services (design/PM, install/dismantle, logistics), tax, and total. Use the calibrated service ratios from the SKILL.md for this project type.`;

          const response = await fetch(GEMINI_WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: [{ role: 'user', content: promptText }],
              model: 'gemini-2.5-flash'
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Gemini API failed');
          }

          const data = await response.json();
          console.log('Gemini AI Quote:', data);
          setAiQuote(data.quote);

        } catch (err) {
          console.error('AI Quote error:', err);
          setError('AI Quote failed: ' + err.message);
        } finally {
          setLoadingAiQuote(false);
        }
      };

      const handleImageUpload = async (file) => {
        if (!file) return;

        setError('');
        setAnalyzing(true);
        setUploadedImage(URL.createObjectURL(file));

        try {
          // Convert file to base64 using Promise wrapper
          const base64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
              const result = event.target.result;
              if (!result) {
                reject(new Error('Failed to read image'));
                return;
              }
              const base64Data = result.split(',')[1];
              resolve(base64Data);
            };
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsDataURL(file);
          });

          const extracted = await analyzeWithClaude(base64, pdfText);
          updateEstimates(extracted);
        } catch (err) {
          setError('Error analyzing rendering: ' + err.message);
          // Don't clear the image - user can still see what they uploaded
        } finally {
          setAnalyzing(false);
        }
      };

      const handlePdfUpload = async (file) => {
        if (!file) return;

        setError('');
        setAnalyzing(true);
        setUploadedPDF(file.name);

        try {
          const text = await extractPdfText(file);
          setPdfText(text);

          const extracted = await analyzeWithClaude(null, text);
          updateEstimates(extracted);
        } catch (err) {
          setError('Error analyzing PDF: ' + err.message);
          setUploadedPDF(null);
          setPdfText('');
        } finally {
          setAnalyzing(false);
        }
      };

      const handleFileUpload = (file) => {
        if (!file) return;

        if (file.type === 'application/pdf') {
          handlePdfUpload(file);
        } else if (file.type.startsWith('image/')) {
          handleImageUpload(file);
        } else {
          setError('Please upload an image (JPG, PNG) or PDF file');
        }
      };



      const downloadQuote = () => {
        if (!estimates) return;

        const quoteHTML = `<!DOCTYPE html><html><head><style>
          body { font-family: Arial, sans-serif; max-width: 900px; margin: 0; padding: 20px; }
          .header { text-align: center; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }
          .header h1 { margin: 0; color: #1f2937; }
          .specs { background: #f3f4f6; padding: 15px; border-radius: 6px; margin: 20px 0; font-size: 14px; }
          .specs div { padding: 5px 0; }
          .estimate-section { margin: 30px 0; border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; }
          .tier-badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: bold; font-size: 12px; margin-bottom: 10px; }
          .aggressive { background: #fee2e2; color: #991b1b; }
          .middle { background: #fef3c7; color: #92400e; }
          .conservative { background: #dbeafe; color: #0c2d6b; }
          .line-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
          .total-line { display: flex; justify-content: space-between; padding: 12px 0; border-top: 2px solid #1f2937; font-size: 18px; font-weight: bold; margin-top: 10px; }
        </style></head><body>
          <div class="header"><h1>BoothIQ Quote</h1><p>Generated: ${new Date().toLocaleDateString()}</p></div>
          
          <div class="specs">
            <div><strong>Booth Dimensions:</strong> ${width}ft √ó ${length}ft</div>
            <div><strong>Environment:</strong> ${indoor ? 'Indoor' : 'Outdoor'}</div>
            <div><strong>Duration:</strong> ${duration} days</div>
            <div><strong>Ground Level:</strong> ${groundLevel === 'yes' ? 'Yes' : groundLevel === 'no' ? 'No' : 'Not Sure'}</div>
            <div><strong>Location:</strong> ${location.charAt(0).toUpperCase() + location.slice(1)}</div>
          </div>
          
          <div class="estimate-section">
            <div class="tier-badge aggressive">AGGRESSIVE</div>
            <h2>Aggressive Estimate</h2>
            <div class="line-item"><span>Materials</span><span>$${estimates.aggressive.materials.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="line-item"><span>Design & PM</span><span>$${estimates.aggressive.designPM.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="line-item"><span>Install & Dismantle</span><span>$${estimates.aggressive.installDismantle.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="line-item"><span>Logistics</span><span>$${estimates.aggressive.logistics.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="total-line"><span>TOTAL</span><span>$${estimates.aggressive.total.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
          </div>

          <div class="estimate-section">
            <div class="tier-badge middle">MIDDLE (RECOMMENDED)</div>
            <h2>Middle Estimate</h2>
            <div class="line-item"><span>Materials</span><span>$${estimates.middle.materials.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="line-item"><span>Design & PM</span><span>$${estimates.middle.designPM.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="line-item"><span>Install & Dismantle</span><span>$${estimates.middle.installDismantle.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="line-item"><span>Logistics</span><span>$${estimates.middle.logistics.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="line-item"><span>Contingency</span><span>$${estimates.middle.contingency.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="total-line"><span>TOTAL</span><span>$${estimates.middle.total.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
          </div>

          <div class="estimate-section">
            <div class="tier-badge conservative">CONSERVATIVE</div>
            <h2>Conservative Estimate</h2>
            <div class="line-item"><span>Materials</span><span>$${estimates.conservative.materials.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="line-item"><span>Design & PM</span><span>$${estimates.conservative.designPM.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="line-item"><span>Install & Dismantle</span><span>$${estimates.conservative.installDismantle.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="line-item"><span>Logistics</span><span>$${estimates.conservative.logistics.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="line-item"><span>Contingency</span><span>$${estimates.conservative.contingency.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
            <div class="total-line"><span>TOTAL</span><span>$${estimates.conservative.total.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span></div>
          </div>
        </body></html>`;

        const blob = new Blob([quoteHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `boothiq-quote-${new Date().toISOString().split('T')[0]}.html`;
        link.click();
      };

      return (
        <div className="container">
          <div className="card">
            <div className="header">
              <h1>BoothIQ</h1>
              <p>Quick booth cost estimation with custom specifications</p>
            </div>

            {error && <div className="error">{error}</div>}

            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Location</label>
                <select
                  value={location}
                  onChange={(e) => setLocation(e.target.value)}
                >
                  <option value="toronto">Toronto</option>
                  <option value="montreal">Montreal</option>
                  <option value="usa">USA</option>
                </select>
              </div>

              <div className="form-group">
                <label className="form-label">Environment</label>
                <div className="toggle-group">
                  <button
                    className={`toggle-btn ${indoor ? 'active' : ''}`}
                    onClick={() => setIndoor(true)}
                  >
                    üè¢ Indoor
                  </button>
                  <button
                    className={`toggle-btn ${!indoor ? 'active' : ''}`}
                    onClick={() => setIndoor(false)}
                  >
                    üå§Ô∏è Outdoor
                  </button>
                </div>
              </div>
            </div>

            <div className="form-group">
              <label className="form-label">Booth Dimensions (feet)</label>
              <div className="dimensions-grid">
                <div>
                  <label style={{ fontSize: '12px', color: '#6b7280', marginBottom: '5px', display: 'block' }}>Width</label>
                  <input
                    type="number"
                    value={width}
                    onChange={(e) => setWidth(e.target.value)}
                    min="1"
                    step="0.5"
                    placeholder="Width"
                  />
                </div>
                <div>
                  <label style={{ fontSize: '12px', color: '#6b7280', marginBottom: '5px', display: 'block' }}>Length</label>
                  <input
                    type="number"
                    value={length}
                    onChange={(e) => setLength(e.target.value)}
                    min="1"
                    step="0.5"
                    placeholder="Length"
                  />
                </div>
              </div>
            </div>

            <div className="form-group">
              <label className="form-label">Duration of Use</label>
              <div className="duration-buttons">
                {DURATION_OPTIONS.map((day) => (
                  <button
                    key={day}
                    className={`toggle-btn ${duration === day ? 'active' : ''}`}
                    onClick={() => setDuration(day)}
                  >
                    {day} day{day !== 1 ? 's' : ''}
                  </button>
                ))}
              </div>
            </div>

            <div className="form-group">
              <label className="form-label">Is Ground Level?</label>
              <div className="three-state-toggle">
                <button
                  className={`toggle-btn ${groundLevel === 'yes' ? 'active' : ''}`}
                  onClick={() => setGroundLevel('yes')}
                >
                  ‚úì Yes
                </button>
                <button
                  className={`toggle-btn ${groundLevel === 'not-sure' ? 'active' : ''}`}
                  onClick={() => setGroundLevel('not-sure')}
                >
                  ? Not Sure
                </button>
                <button
                  className={`toggle-btn ${groundLevel === 'no' ? 'active' : ''}`}
                  onClick={() => setGroundLevel('no')}
                >
                  ‚úó No
                </button>
              </div>
            </div>

            <div className="divider" style={{ marginTop: 40 }}>
              <label className="form-label">Or upload rendering or PDF for detailed analysis</label>
              <div
                className={`upload-zone ${dragging ? 'dragging' : ''}`}
                onClick={() => fileInputRef.current?.click()}
                onDragOver={(e) => { e.preventDefault(); setDragging(true); }}
                onDragLeave={() => setDragging(false)}
                onDrop={(e) => {
                  e.preventDefault();
                  setDragging(false);
                  if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0]);
                }}
              >
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*,.pdf"
                  onChange={(e) => e.target.files[0] && handleFileUpload(e.target.files[0])}
                  style={{ display: 'none' }}
                />
                {analyzing ? (
                  <div className="loading">
                    <div className="spinner"></div>
                    <p>Analyzing file...</p>
                  </div>
                ) : (
                  <>
                    <p>Drop rendering or PDF here or click to upload</p>
                    <p>JPG, PNG, or PDF format</p>
                  </>
                )}
              </div>
            </div>

            {uploadedImage && (
              <div className="divider">
                <h3 style={{ margin: '0 0 15px 0', color: '#374151', fontSize: '14px', fontWeight: '600' }}>Uploaded Image</h3>
                <img src={uploadedImage} alt="Booth rendering" className="preview-img" />
              </div>
            )}

            {uploadedPDF && (
              <div className="divider">
                <h3 style={{ margin: '0 0 15px 0', color: '#374151', fontSize: '14px', fontWeight: '600' }}>Uploaded PDF</h3>
                <div className="pdf-badge">üìÑ {uploadedPDF}</div>
              </div>
            )}

            {estimates ? (
              <div>
                <div style={{ background: '#f3f4f6', padding: '15px', borderRadius: '6px', marginBottom: '20px', fontSize: '14px' }}>
                  <strong>Current Specs:</strong> {width}ft √ó {length}ft | {indoor ? 'Indoor' : 'Outdoor'} | {duration} days | Ground: {groundLevel === 'yes' ? 'Level' : groundLevel === 'no' ? 'Uneven' : 'Unknown'}
                </div>
                <div className="estimates-grid">
                  {[
                    { tier: 'aggressive', label: 'Aggressive (Budget)', class: 'aggressive' },
                    { tier: 'middle', label: 'Middle (Recommended)', class: 'middle' },
                    { tier: 'conservative', label: 'Conservative (Premium)', class: 'conservative' }
                  ].map(({ tier, label, class: className }) => (
                    <div key={tier} className={`estimate-card ${className}`}>
                      <h3>{label}</h3>
                      <div className="line-item">
                        <span className="line-item-label">Materials</span>
                        <span className="line-item-amount">${estimates[tier].materials.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
                      </div>
                      <div className="line-item">
                        <span className="line-item-label">Design & PM</span>
                        <span className="line-item-amount">${estimates[tier].designPM.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
                      </div>
                      <div className="line-item">
                        <span className="line-item-label">I&D Labor</span>
                        <span className="line-item-amount">${estimates[tier].installDismantle.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
                      </div>
                      <div className="line-item">
                        <span className="line-item-label">Logistics</span>
                        <span className="line-item-amount">${estimates[tier].logistics.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
                      </div>
                      {estimates[tier].contingency > 0 && (
                        <div className="line-item">
                          <span className="line-item-label">Contingency</span>
                          <span className="line-item-amount">${estimates[tier].contingency.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
                        </div>
                      )}
                      <div className="total-line">
                        <span>TOTAL</span>
                        <span>${estimates[tier].total.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
                      </div>
                    </div>
                  ))}
                </div>
                <button
                  className="btn btn-ai"
                  onClick={getAIQuote}
                  disabled={loadingAiQuote}
                >
                  {loadingAiQuote ? '‚è≥ Generating AI Quote...' : '‚ú® Get AI Quote (Gemini)'}
                </button>

                {aiQuote && (
                  <div className="ai-quote-section">
                    <div className="ai-quote-header">
                      <h3>AI-Generated Quote</h3>
                      <span className="ai-badge">{aiQuote.project_type?.replace('_', ' ').toUpperCase() || 'STANDARD'}</span>
                    </div>

                    <div className="ai-quote-grid">
                      <div className="ai-quote-card">
                        <h4>Materials</h4>
                        {aiQuote.materials?.walls > 0 && (
                          <div className="ai-line-item">
                            <span>Walls/Fabrication</span>
                            <span>${aiQuote.materials.walls?.toLocaleString() || 0}</span>
                          </div>
                        )}
                        {aiQuote.materials?.flooring > 0 && (
                          <div className="ai-line-item">
                            <span>Flooring</span>
                            <span>${aiQuote.materials.flooring?.toLocaleString() || 0}</span>
                          </div>
                        )}
                        {aiQuote.materials?.graphics > 0 && (
                          <div className="ai-line-item">
                            <span>Graphics/Signage</span>
                            <span>${aiQuote.materials.graphics?.toLocaleString() || 0}</span>
                          </div>
                        )}
                        {aiQuote.materials?.av_lighting > 0 && (
                          <div className="ai-line-item">
                            <span>AV & Lighting</span>
                            <span>${aiQuote.materials.av_lighting?.toLocaleString() || 0}</span>
                          </div>
                        )}
                        {aiQuote.materials?.furniture > 0 && (
                          <div className="ai-line-item">
                            <span>Furniture</span>
                            <span>${aiQuote.materials.furniture?.toLocaleString() || 0}</span>
                          </div>
                        )}
                        {aiQuote.materials?.other > 0 && (
                          <div className="ai-line-item">
                            <span>Other</span>
                            <span>${aiQuote.materials.other?.toLocaleString() || 0}</span>
                          </div>
                        )}
                        <div className="ai-line-item subtotal">
                          <span>Materials Subtotal</span>
                          <span>${aiQuote.materials?.subtotal?.toLocaleString() || 0}</span>
                        </div>
                      </div>

                      <div className="ai-quote-card">
                        <h4>Services</h4>
                        <div className="ai-line-item">
                          <span>Design & PM ({(aiQuote.services?.design_pm_percent * 100)?.toFixed(0) || 0}%)</span>
                          <span>${aiQuote.services?.design_pm?.toLocaleString() || 0}</span>
                        </div>
                        <div className="ai-line-item">
                          <span>Install & Dismantle ({(aiQuote.services?.install_dismantle_percent * 100)?.toFixed(0) || 0}%)</span>
                          <span>${aiQuote.services?.install_dismantle?.toLocaleString() || 0}</span>
                        </div>
                        <div className="ai-line-item">
                          <span>Logistics ({(aiQuote.services?.logistics_percent * 100)?.toFixed(0) || 0}%)</span>
                          <span>${aiQuote.services?.logistics?.toLocaleString() || 0}</span>
                        </div>
                        <div className="ai-line-item subtotal">
                          <span>Services Subtotal</span>
                          <span>${aiQuote.services?.subtotal?.toLocaleString() || 0}</span>
                        </div>
                      </div>

                      <div className="ai-total-section">
                        {aiQuote.contingency > 0 && (
                          <div className="ai-line-item" style={{ justifyContent: 'center', gap: '20px' }}>
                            <span>Contingency:</span>
                            <span>${aiQuote.contingency?.toLocaleString() || 0}</span>
                          </div>
                        )}
                        <div className="ai-line-item" style={{ justifyContent: 'center', gap: '20px' }}>
                          <span>Subtotal:</span>
                          <span>${aiQuote.subtotal_before_tax?.toLocaleString() || 0}</span>
                        </div>
                        <div className="ai-line-item" style={{ justifyContent: 'center', gap: '20px' }}>
                          <span>Tax ({(aiQuote.tax_rate * 100)?.toFixed(2) || 0}%):</span>
                          <span>${aiQuote.tax_amount?.toLocaleString() || 0}</span>
                        </div>
                        <div className="ai-total">${aiQuote.total?.toLocaleString() || 0}</div>
                        <div className={`ai-confidence ${aiQuote.confidence || 'medium'}`}>
                          Confidence: {(aiQuote.confidence || 'medium').toUpperCase()}
                        </div>
                      </div>

                      {aiQuote.notes && aiQuote.notes.length > 0 && (
                        <div className="ai-notes">
                          <h4>Notes & Assumptions</h4>
                          <ul>
                            {aiQuote.notes.map((note, i) => <li key={i}>{note}</li>)}
                          </ul>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                <button className="btn" onClick={downloadQuote} style={{ marginTop: '20px' }}>üì• Download Quote as HTML</button>
              </div>
            ) : (
              <div className="empty-state">
                <p>Enter booth dimensions above to generate estimates</p>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<BoothIQ />, document.getElementById('root'));
  </script>
</body>
</html>
