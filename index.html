<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BoothIQ - Professional Booth Estimation</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽª</text></svg>">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.js"></script>
  <style>
    /* Apple-inspired design system */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.47059;
      letter-spacing: -0.022em;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 60px 20px;
    }

    /* Header - minimal, centered */
    .header {
      text-align: center;
      margin-bottom: 48px;
    }
    .header h1 {
      font-size: 48px;
      font-weight: 600;
      letter-spacing: -0.003em;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #1d1d1f 0%, #515154 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header p {
      font-size: 21px;
      color: #86868b;
      font-weight: 400;
    }

    /* Cards with subtle depth */
    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 40px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }

    .card-header {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #1d1d1f;
    }

    /* Form elements - Apple style */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }

    .form-group {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #86868b;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 8px;
    }

    select, input[type="number"] {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #d2d2d7;
      border-radius: 12px;
      font-size: 17px;
      font-family: inherit;
      background: #ffffff;
      color: #1d1d1f;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      -webkit-appearance: none;
      appearance: none;
    }

    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2386868b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      padding-right: 40px;
    }

    select:focus, input[type="number"]:focus {
      outline: none;
      border-color: #0071e3;
      box-shadow: 0 0 0 4px rgba(0,113,227,0.1);
    }

    /* Segmented controls */
    .segment-control {
      display: flex;
      background: #f5f5f7;
      border-radius: 10px;
      padding: 3px;
      gap: 0;
    }

    .segment-btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #86868b;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .segment-btn:hover {
      color: #1d1d1f;
    }

    .segment-btn.active {
      background: #ffffff;
      color: #1d1d1f;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Duration pills */
    .duration-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill-btn {
      padding: 10px 20px;
      border: 1px solid #d2d2d7;
      background: #ffffff;
      border-radius: 980px;
      font-size: 14px;
      font-weight: 500;
      color: #1d1d1f;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .pill-btn:hover {
      border-color: #86868b;
    }

    .pill-btn.active {
      background: #1d1d1f;
      border-color: #1d1d1f;
      color: #ffffff;
    }

    /* Dimensions grid */
    .dimensions-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 12px;
      align-items: end;
    }

    .dimensions-x {
      font-size: 24px;
      color: #86868b;
      text-align: center;
      padding-bottom: 14px;
    }

    /* Upload zone */
    .upload-zone {
      border: 2px dashed #d2d2d7;
      border-radius: 18px;
      padding: 48px;
      text-align: center;
      cursor: pointer;
      background: #fafafa;
      transition: all 0.2s ease;
    }

    .upload-zone:hover {
      border-color: #86868b;
      background: #f5f5f7;
    }

    .upload-zone.dragging {
      border-color: #0071e3;
      background: rgba(0,113,227,0.04);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.6;
    }

    .upload-zone p {
      margin: 0;
      color: #86868b;
      font-size: 14px;
    }

    .upload-zone p:first-of-type {
      font-size: 17px;
      font-weight: 500;
      color: #1d1d1f;
      margin-bottom: 4px;
    }

    /* Primary CTA - Apple blue */
    .btn-primary {
      width: 100%;
      padding: 18px 32px;
      background: #0071e3;
      color: #ffffff;
      border: none;
      border-radius: 14px;
      font-size: 17px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      letter-spacing: -0.022em;
    }

    .btn-primary:hover {
      background: #0077ed;
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-primary:disabled {
      background: #d2d2d7;
      cursor: not-allowed;
    }

    /* Secondary button */
    .btn-secondary {
      width: 100%;
      padding: 14px 24px;
      background: transparent;
      color: #0071e3;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .btn-secondary:hover {
      background: rgba(0,113,227,0.08);
    }

    /* AI Quote result - hero display */
    .quote-result {
      text-align: center;
      padding: 48px 32px;
    }

    .quote-badge {
      display: inline-block;
      padding: 6px 16px;
      background: #f5f5f7;
      border-radius: 980px;
      font-size: 12px;
      font-weight: 600;
      color: #86868b;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 16px;
    }

    .quote-badge.ai {
      background: linear-gradient(135deg, #5e5ce6 0%, #bf5af2 100%);
      color: #ffffff;
    }

    .quote-total {
      font-size: 72px;
      font-weight: 600;
      letter-spacing: -0.03em;
      color: #1d1d1f;
      line-height: 1;
      margin-bottom: 8px;
    }

    .quote-label {
      font-size: 17px;
      color: #86868b;
      margin-bottom: 24px;
    }

    .confidence-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 980px;
      font-size: 14px;
      font-weight: 500;
    }

    .confidence-badge.high {
      background: rgba(52,199,89,0.12);
      color: #248a3d;
    }

    .confidence-badge.medium {
      background: rgba(255,159,10,0.12);
      color: #b25000;
    }

    .confidence-badge.low {
      background: rgba(255,59,48,0.12);
      color: #d70015;
    }

    /* Breakdown sections */
    .breakdown-section {
      border-top: 1px solid #e8e8ed;
      padding-top: 32px;
      margin-top: 32px;
    }

    .breakdown-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 640px) {
      .breakdown-grid { grid-template-columns: 1fr; }
    }

    .breakdown-card {
      background: #f5f5f7;
      border-radius: 14px;
      padding: 20px;
    }

    .breakdown-title {
      font-size: 12px;
      font-weight: 600;
      color: #86868b;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 16px;
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 15px;
    }

    .breakdown-item-label {
      color: #86868b;
    }

    .breakdown-item-value {
      font-weight: 500;
      color: #1d1d1f;
    }

    .breakdown-subtotal {
      border-top: 1px solid #d2d2d7;
      margin-top: 8px;
      padding-top: 12px;
    }

    .breakdown-subtotal .breakdown-item-label,
    .breakdown-subtotal .breakdown-item-value {
      color: #1d1d1f;
      font-weight: 600;
    }

    /* Summary row */
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 16px 0;
      font-size: 17px;
      border-top: 1px solid #e8e8ed;
    }

    .summary-row:first-child {
      border-top: none;
    }

    .summary-row.total {
      font-size: 21px;
      font-weight: 600;
    }

    /* Notes section */
    .notes-section {
      background: #fffbeb;
      border-radius: 14px;
      padding: 20px;
      margin-top: 24px;
    }

    .notes-title {
      font-size: 14px;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 12px;
    }

    .notes-list {
      margin: 0;
      padding-left: 20px;
      font-size: 14px;
      color: #78350f;
    }

    .notes-list li {
      margin-bottom: 6px;
    }

    /* Collapsible section */
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      cursor: pointer;
      border-top: 1px solid #e8e8ed;
    }

    .collapsible-header h3 {
      font-size: 17px;
      font-weight: 600;
      color: #1d1d1f;
    }

    .collapsible-toggle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #f5f5f7;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #86868b;
      transition: transform 0.2s ease;
    }

    .collapsible-toggle.open {
      transform: rotate(180deg);
    }

    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .collapsible-content.open {
      max-height: 2000px;
    }

    /* Template estimates (secondary) */
    .template-estimates {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      padding-bottom: 24px;
    }

    @media (max-width: 768px) {
      .template-estimates { grid-template-columns: 1fr; }
    }

    .template-card {
      background: #f5f5f7;
      border-radius: 14px;
      padding: 20px;
    }

    .template-card.budget { border-left: 4px solid #ff3b30; }
    .template-card.standard { border-left: 4px solid #ff9500; }
    .template-card.premium { border-left: 4px solid #007aff; }

    .template-tier {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 4px;
    }

    .template-card.budget .template-tier { color: #ff3b30; }
    .template-card.standard .template-tier { color: #ff9500; }
    .template-card.premium .template-tier { color: #007aff; }

    .template-total {
      font-size: 28px;
      font-weight: 600;
      color: #1d1d1f;
    }

    /* Error state */
    .error-banner {
      background: rgba(255,59,48,0.08);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
      font-size: 15px;
      color: #d70015;
    }

    /* Loading state */
    .loading-state {
      text-align: center;
      padding: 48px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e8e8ed;
      border-top-color: #0071e3;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #86868b;
      font-size: 15px;
    }

    /* Preview images */
    .preview-img {
      max-width: 100%;
      border-radius: 14px;
      margin-top: 16px;
    }

    .pdf-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: #f5f5f7;
      border-radius: 10px;
      font-size: 14px;
      color: #1d1d1f;
      margin-top: 16px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 64px 32px;
      color: #86868b;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .container { padding: 40px 16px; }
      .card { padding: 24px; border-radius: 14px; }
      .header h1 { font-size: 34px; }
      .header p { font-size: 17px; }
      .quote-total { font-size: 48px; }
      .form-grid { gap: 16px; }
      .dimensions-grid { grid-template-columns: 1fr; gap: 8px; }
      .dimensions-x { display: none; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // PDF.js is optional - app works without it (just no PDF upload)
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.js';
    }

    // Cloudflare Worker URLs - handle API keys and SKILL.md server-side
    const CLAUDE_WORKER_URL = 'https://boothiq-proxy.raj-lucia001.workers.dev';
    const GEMINI_WORKER_URL = 'https://boothiq-gemini.raj-lucia001.workers.dev';

    const DURATION_OPTIONS = [1, 3, 7, 30];

    const CATALOG_PRICING = {
      walls: {
        paintedMDF: 68.75,
        oakWood: 103.13,
        complexMillwork: 157.78,
      },
      flooring: {
        standardCarpet: 5.50,
        printedVinyl: 14.30,
        gFloorNew: 27.27,
        astroTurf: 16.92
      }
    };

    function BoothIQ() {
      const [location, setLocation] = React.useState('toronto');
      const [width, setWidth] = React.useState(10);
      const [length, setLength] = React.useState(10);
      const [indoor, setIndoor] = React.useState(true);
      const [duration, setDuration] = React.useState(3);
      const [groundLevel, setGroundLevel] = React.useState('not-sure');
      const [components, setComponents] = React.useState(null);
      const [estimates, setEstimates] = React.useState(null);
      const [uploadedImage, setUploadedImage] = React.useState(null);
      const [uploadedPDF, setUploadedPDF] = React.useState(null);
      const [pdfText, setPdfText] = React.useState('');
      const [analyzing, setAnalyzing] = React.useState(false);
      const [error, setError] = React.useState('');
      const fileInputRef = React.useRef(null);
      const [dragging, setDragging] = React.useState(false);
      const [aiQuote, setAiQuote] = React.useState(null);
      const [loadingAiQuote, setLoadingAiQuote] = React.useState(false);
      const [showTemplates, setShowTemplates] = React.useState(false);

      const calculateBoothSpecs = () => {
        const w = parseFloat(width) || 0;
        const l = parseFloat(length) || 0;
        const perimeter = (w + l) * 2;
        const wallSqft = perimeter * 10;
        const floorSqft = w * l;

        return {
          wallSqft,
          floorSqft,
          wallType: 'paintedMDF',
          floorType: 'standardCarpet',
          graphics: 'moderate'
        };
      };

      const extractPdfText = async (file) => {
        if (typeof pdfjsLib === 'undefined') {
          throw new Error('PDF support unavailable - try uploading an image instead');
        }
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          let fullText = '';

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map((item) => item.str).join(' ');
            fullText += pageText + '\n';
          }

          return fullText;
        } catch (err) {
          throw new Error('Failed to extract PDF text: ' + err.message);
        }
      };

      const calculateMaterials = (comps) => {
        let cost = 0;
        cost += (comps.wallSqft || 0) * (CATALOG_PRICING.walls[comps.wallType] || 68.75);
        const floorPrices = {
          standardCarpet: 5.50,
          printedVinyl: 14.30,
          gFloorNew: 27.27,
          astroTurf: 16.92
        };
        cost += (comps.floorSqft || 0) * (floorPrices[comps.floorType] || 5.50);

        const graphicsPrices = { modest: 12, moderate: 25, premium: 45, extensive: 60 };
        cost += (comps.graphicsEstimate || 100) * (graphicsPrices[comps.graphics] || 25);

        return cost;
      };

      const calculateEstimates = (comps, loc, dur, env, ground) => {
        const materials = calculateMaterials(comps);
        const subtotal = materials;

        const serviceRates = {
          toronto: { designPM: 0.09, installDismantle: 0.14, logistics: 0.05 },
          montreal: { designPM: 0.12, installDismantle: 0.36, logistics: 0.12 },
          usa: { designPM: 0.10, installDismantle: 0.20, logistics: 0.15 }
        };

        const rates = serviceRates[loc] || serviceRates.toronto;

        const durationMultipliers = { 1: 1.0, 3: 0.82, 7: 0.60, 30: 0.65 };
        const durationMult = durationMultipliers[dur] || 0.95;
        const outdoorMult = env === 'outdoor' ? 1.15 : 1.0;
        const groundMultiplier = ground === 'no' ? 1.20 : ground === 'yes' ? 1.0 : 1.08;

        const estimates = {
          aggressive: {
            materials: materials * 0.85,
            designPM: subtotal * rates.designPM * 0.85 * durationMult * outdoorMult,
            installDismantle: subtotal * rates.installDismantle * 0.80 * outdoorMult * groundMultiplier,
            logistics: subtotal * rates.logistics * 0.90 * durationMult,
            contingency: 0
          },
          middle: {
            materials: materials,
            designPM: subtotal * rates.designPM * durationMult * outdoorMult,
            installDismantle: subtotal * rates.installDismantle * outdoorMult * groundMultiplier,
            logistics: subtotal * rates.logistics * durationMult,
            contingency: subtotal * 0.05
          },
          conservative: {
            materials: materials * 1.20,
            designPM: subtotal * rates.designPM * 1.15 * durationMult * outdoorMult,
            installDismantle: subtotal * rates.installDismantle * 1.20 * outdoorMult * groundMultiplier,
            logistics: subtotal * rates.logistics * 1.15 * durationMult,
            contingency: subtotal * 0.15
          }
        };

        return Object.entries(estimates).reduce((acc, [tier, costs]) => {
          acc[tier] = {
            ...costs,
            total: Object.values(costs).reduce((sum, val) => sum + val, 0)
          };
          return acc;
        }, {});
      };

      const updateEstimates = (newComps = null) => {
        const specs = newComps || calculateBoothSpecs();
        setComponents(specs);
        const calcs = calculateEstimates(specs, location, duration, indoor ? 'indoor' : 'outdoor', groundLevel);
        setEstimates(calcs);
      };

      React.useEffect(() => {
        updateEstimates();
      }, [location, width, length, indoor, duration, groundLevel]);

      const analyzeWithClaude = async (imageBase64 = null, pdfTextContent = '') => {
        try {
          let promptText = '';

          if (pdfTextContent && imageBase64) {
            promptText = `You have a booth rendering image and the following PDF parts list. Combine both to extract component details.\n\nPDF Content:\n${pdfTextContent}\n\nReturn ONLY valid JSON: {wallSqft: number, floorSqft: number, wallType: "paintedMDF"|"oakWood"|"complexMillwork", floorType: "standardCarpet"|"printedVinyl"|"gFloorNew"|"astroTurf", graphics: "modest"|"moderate"|"premium"|"extensive", graphicsEstimate: number}. No markdown, no explanation.`;
          } else if (pdfTextContent) {
            promptText = `Extract booth component details from this parts list PDF text.\n\nPDF Content:\n${pdfTextContent}\n\nReturn ONLY valid JSON: {wallSqft: number, floorSqft: number, wallType: "paintedMDF"|"oakWood"|"complexMillwork", floorType: "standardCarpet"|"printedVinyl"|"gFloorNew"|"astroTurf", graphics: "modest"|"moderate"|"premium"|"extensive", graphicsEstimate: number}. No markdown, no explanation.`;
          } else if (imageBase64) {
            promptText = 'Analyze booth rendering and return JSON: {wallSqft: number, floorSqft: number, wallType: "paintedMDF"|"oakWood"|"complexMillwork", floorType: "standardCarpet"|"printedVinyl"|"gFloorNew"|"astroTurf", graphics: "modest"|"moderate"|"premium"|"extensive", graphicsEstimate: number}. Return ONLY valid JSON, no markdown or explanation.';
          }

          const response = await fetch(CLAUDE_WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: [{ role: 'user', content: promptText }]
            })
          });

          if (!response.ok) throw new Error('Worker API failed');
          const data = await response.json();
          console.log('Claude analysis:', data.content[0].text);
          return JSON.parse(data.content[0].text);
        } catch (err) {
          throw new Error('Analysis failed: ' + err.message);
        }
      };

      // Get structured AI quote from Gemini
      const getAIQuote = async () => {
        setError('');
        setLoadingAiQuote(true);
        setAiQuote(null);

        try {
          const specs = {
            width: parseFloat(width) || 10,
            length: parseFloat(length) || 10,
            location: location,
            environment: indoor ? 'indoor' : 'outdoor',
            duration: duration,
            groundLevel: groundLevel,
            uploadedPdf: uploadedPDF || null,
            pdfContent: pdfText || null
          };

          let promptText = `Generate a detailed booth quote for:
- Dimensions: ${specs.width}ft Ã— ${specs.length}ft (${specs.width * specs.length} sq ft)
- Location: ${specs.location}
- Environment: ${specs.environment}
- Duration: ${specs.duration} days
- Ground Level: ${specs.groundLevel === 'yes' ? 'Yes (level floor)' : specs.groundLevel === 'no' ? 'No (uneven, requires leveling)' : 'Unknown'}`;

          if (specs.pdfContent) {
            promptText += `\n\nAdditional context from uploaded PDF:\n${specs.pdfContent.substring(0, 2000)}`;
          }

          promptText += `\n\nProvide a complete quote with materials breakdown, services (design/PM, install/dismantle, logistics), tax, and total. Use the calibrated service ratios from the SKILL.md for this project type.`;

          const response = await fetch(GEMINI_WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: [{ role: 'user', content: promptText }],
              model: 'gemini-2.5-pro'
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Gemini API failed');
          }

          const data = await response.json();
          console.log('Gemini AI Quote:', JSON.stringify(data, null, 2));
          setAiQuote(data.quote);

        } catch (err) {
          console.error('AI Quote error:', err);
          setError('AI Quote failed: ' + err.message);
        } finally {
          setLoadingAiQuote(false);
        }
      };

      const handleImageUpload = async (file) => {
        if (!file) return;

        setError('');
        setAnalyzing(true);
        setUploadedImage(URL.createObjectURL(file));

        try {
          const base64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
              const result = event.target.result;
              if (!result) {
                reject(new Error('Failed to read image'));
                return;
              }
              const base64Data = result.split(',')[1];
              resolve(base64Data);
            };
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsDataURL(file);
          });

          const extracted = await analyzeWithClaude(base64, pdfText);
          updateEstimates(extracted);
        } catch (err) {
          setError('Error analyzing rendering: ' + err.message);
        } finally {
          setAnalyzing(false);
        }
      };

      const handlePdfUpload = async (file) => {
        if (!file) return;

        setError('');
        setAnalyzing(true);
        setUploadedPDF(file.name);

        try {
          const text = await extractPdfText(file);
          setPdfText(text);

          const extracted = await analyzeWithClaude(null, text);
          updateEstimates(extracted);
        } catch (err) {
          setError('Error analyzing PDF: ' + err.message);
          setUploadedPDF(null);
          setPdfText('');
        } finally {
          setAnalyzing(false);
        }
      };

      const handleFileUpload = (file) => {
        if (!file) return;

        if (file.type === 'application/pdf') {
          handlePdfUpload(file);
        } else if (file.type.startsWith('image/')) {
          handleImageUpload(file);
        } else {
          setError('Please upload an image (JPG, PNG) or PDF file');
        }
      };

      const formatCurrency = (value) => {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(value || 0);
      };

      const downloadQuote = () => {
        if (!aiQuote) return;

        const quoteHTML = `<!DOCTYPE html><html><head><style>
          body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; color: #1d1d1f; }
          .header { text-align: center; margin-bottom: 40px; }
          .header h1 { font-size: 32px; margin: 0 0 8px 0; }
          .header p { color: #86868b; margin: 0; }
          .specs { background: #f5f5f7; padding: 20px; border-radius: 12px; margin: 24px 0; }
          .total-section { text-align: center; padding: 32px; background: #f5f5f7; border-radius: 12px; margin: 24px 0; }
          .total-amount { font-size: 48px; font-weight: 600; }
          .section { margin: 24px 0; }
          .section h3 { font-size: 14px; color: #86868b; text-transform: uppercase; margin-bottom: 12px; }
          .line-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e8e8ed; }
        </style></head><body>
          <div class="header">
            <h1>BoothIQ Quote</h1>
            <p>Generated: ${new Date().toLocaleDateString()}</p>
          </div>

          <div class="specs">
            <strong>Specifications:</strong> ${width}ft Ã— ${length}ft | ${location.charAt(0).toUpperCase() + location.slice(1)} | ${indoor ? 'Indoor' : 'Outdoor'} | ${duration} days
          </div>

          <div class="total-section">
            <div class="total-amount">${formatCurrency(aiQuote.total)}</div>
            <p>Total Estimate (incl. ${((aiQuote.tax_rate || 0) * 100).toFixed(2)}% tax)</p>
          </div>

          <div class="section">
            <h3>Materials - ${formatCurrency(aiQuote.materials?.subtotal)}</h3>
            ${aiQuote.materials?.walls > 0 ? `<div class="line-item"><span>Walls/Fabrication</span><span>${formatCurrency(aiQuote.materials.walls)}</span></div>` : ''}
            ${aiQuote.materials?.flooring > 0 ? `<div class="line-item"><span>Flooring</span><span>${formatCurrency(aiQuote.materials.flooring)}</span></div>` : ''}
            ${aiQuote.materials?.graphics > 0 ? `<div class="line-item"><span>Graphics</span><span>${formatCurrency(aiQuote.materials.graphics)}</span></div>` : ''}
            ${aiQuote.materials?.av_lighting > 0 ? `<div class="line-item"><span>AV & Lighting</span><span>${formatCurrency(aiQuote.materials.av_lighting)}</span></div>` : ''}
            ${aiQuote.materials?.furniture > 0 ? `<div class="line-item"><span>Furniture</span><span>${formatCurrency(aiQuote.materials.furniture)}</span></div>` : ''}
          </div>

          <div class="section">
            <h3>Services - ${formatCurrency(aiQuote.services?.subtotal)}</h3>
            <div class="line-item"><span>Design & PM</span><span>${formatCurrency(aiQuote.services?.design_pm)}</span></div>
            <div class="line-item"><span>Install & Dismantle</span><span>${formatCurrency(aiQuote.services?.install_dismantle)}</span></div>
            <div class="line-item"><span>Logistics</span><span>${formatCurrency(aiQuote.services?.logistics)}</span></div>
          </div>

          ${aiQuote.notes?.length > 0 ? `<div class="section"><h3>Notes</h3><ul>${aiQuote.notes.map(n => `<li>${n}</li>`).join('')}</ul></div>` : ''}
        </body></html>`;

        const blob = new Blob([quoteHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `boothiq-quote-${new Date().toISOString().split('T')[0]}.html`;
        link.click();
      };

      return (
        <div className="container">
          {/* Header */}
          <div className="header">
            <h1>BoothIQ</h1>
            <p>Professional booth estimation powered by AI</p>
          </div>

          {error && <div className="error-banner">{error}</div>}

          {/* Input Card */}
          <div className="card">
            <div className="form-grid">
              <div className="form-group">
                <label className="form-label">Location</label>
                <select value={location} onChange={(e) => setLocation(e.target.value)}>
                  <option value="toronto">Toronto</option>
                  <option value="montreal">Montreal</option>
                  <option value="usa">USA</option>
                </select>
              </div>

              <div className="form-group">
                <label className="form-label">Environment</label>
                <div className="segment-control">
                  <button
                    className={`segment-btn ${indoor ? 'active' : ''}`}
                    onClick={() => setIndoor(true)}
                  >
                    Indoor
                  </button>
                  <button
                    className={`segment-btn ${!indoor ? 'active' : ''}`}
                    onClick={() => setIndoor(false)}
                  >
                    Outdoor
                  </button>
                </div>
              </div>
            </div>

            <div className="form-group" style={{ marginTop: 24 }}>
              <label className="form-label">Booth Dimensions (feet)</label>
              <div className="dimensions-grid">
                <input
                  type="number"
                  value={width}
                  onChange={(e) => setWidth(e.target.value)}
                  min="1"
                  step="0.5"
                  placeholder="Width"
                />
                <span className="dimensions-x">Ã—</span>
                <input
                  type="number"
                  value={length}
                  onChange={(e) => setLength(e.target.value)}
                  min="1"
                  step="0.5"
                  placeholder="Length"
                />
              </div>
            </div>

            <div className="form-group" style={{ marginTop: 24 }}>
              <label className="form-label">Duration</label>
              <div className="duration-pills">
                {DURATION_OPTIONS.map((day) => (
                  <button
                    key={day}
                    className={`pill-btn ${duration === day ? 'active' : ''}`}
                    onClick={() => setDuration(day)}
                  >
                    {day} day{day !== 1 ? 's' : ''}
                  </button>
                ))}
              </div>
            </div>

            <div className="form-group" style={{ marginTop: 24 }}>
              <label className="form-label">Ground Level</label>
              <div className="segment-control">
                <button
                  className={`segment-btn ${groundLevel === 'yes' ? 'active' : ''}`}
                  onClick={() => setGroundLevel('yes')}
                >
                  Yes
                </button>
                <button
                  className={`segment-btn ${groundLevel === 'not-sure' ? 'active' : ''}`}
                  onClick={() => setGroundLevel('not-sure')}
                >
                  Not Sure
                </button>
                <button
                  className={`segment-btn ${groundLevel === 'no' ? 'active' : ''}`}
                  onClick={() => setGroundLevel('no')}
                >
                  No
                </button>
              </div>
            </div>

            <div style={{ marginTop: 32 }}>
              <label className="form-label">Upload (Optional)</label>
              <div
                className={`upload-zone ${dragging ? 'dragging' : ''}`}
                onClick={() => fileInputRef.current?.click()}
                onDragOver={(e) => { e.preventDefault(); setDragging(true); }}
                onDragLeave={() => setDragging(false)}
                onDrop={(e) => {
                  e.preventDefault();
                  setDragging(false);
                  if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0]);
                }}
              >
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*,.pdf"
                  onChange={(e) => e.target.files[0] && handleFileUpload(e.target.files[0])}
                  style={{ display: 'none' }}
                />
                {analyzing ? (
                  <div className="loading-state">
                    <div className="spinner"></div>
                    <p className="loading-text">Analyzing file...</p>
                  </div>
                ) : (
                  <>
                    <div className="upload-icon">ðŸ“„</div>
                    <p>Drop rendering or PDF here</p>
                    <p>or click to browse</p>
                  </>
                )}
              </div>

              {uploadedImage && (
                <img src={uploadedImage} alt="Booth rendering" className="preview-img" />
              )}

              {uploadedPDF && (
                <div className="pdf-badge">ðŸ“„ {uploadedPDF}</div>
              )}
            </div>
          </div>

          {/* Primary CTA */}
          <button
            className="btn-primary"
            onClick={getAIQuote}
            disabled={loadingAiQuote}
            style={{ marginBottom: 24 }}
          >
            {loadingAiQuote ? 'Generating Quote...' : 'Generate AI Quote'}
          </button>

          {/* AI Quote Result */}
          {loadingAiQuote && (
            <div className="card">
              <div className="loading-state">
                <div className="spinner"></div>
                <p className="loading-text">AI is analyzing your specifications...</p>
              </div>
            </div>
          )}

          {aiQuote && !loadingAiQuote && (
            <div className="card">
              <div className="quote-result">
                <span className="quote-badge ai">AI-Powered Quote</span>
                <div className="quote-total">{formatCurrency(aiQuote.total)}</div>
                <div className="quote-label">
                  Estimated total including {((aiQuote.tax_rate || 0) * 100).toFixed(1)}% tax
                </div>
                <span className={`confidence-badge ${aiQuote.confidence || 'medium'}`}>
                  {aiQuote.confidence === 'high' ? 'âœ“' : aiQuote.confidence === 'low' ? '!' : '~'}
                  {' '}{(aiQuote.confidence || 'medium').charAt(0).toUpperCase() + (aiQuote.confidence || 'medium').slice(1)} Confidence
                </span>
              </div>

              <div className="breakdown-section">
                <div className="breakdown-grid">
                  <div className="breakdown-card">
                    <div className="breakdown-title">Materials</div>
                    {aiQuote.materials?.walls > 0 && (
                      <div className="breakdown-item">
                        <span className="breakdown-item-label">Walls/Fabrication</span>
                        <span className="breakdown-item-value">{formatCurrency(aiQuote.materials.walls)}</span>
                      </div>
                    )}
                    {aiQuote.materials?.flooring > 0 && (
                      <div className="breakdown-item">
                        <span className="breakdown-item-label">Flooring</span>
                        <span className="breakdown-item-value">{formatCurrency(aiQuote.materials.flooring)}</span>
                      </div>
                    )}
                    {aiQuote.materials?.graphics > 0 && (
                      <div className="breakdown-item">
                        <span className="breakdown-item-label">Graphics</span>
                        <span className="breakdown-item-value">{formatCurrency(aiQuote.materials.graphics)}</span>
                      </div>
                    )}
                    {aiQuote.materials?.av_lighting > 0 && (
                      <div className="breakdown-item">
                        <span className="breakdown-item-label">AV & Lighting</span>
                        <span className="breakdown-item-value">{formatCurrency(aiQuote.materials.av_lighting)}</span>
                      </div>
                    )}
                    {aiQuote.materials?.furniture > 0 && (
                      <div className="breakdown-item">
                        <span className="breakdown-item-label">Furniture</span>
                        <span className="breakdown-item-value">{formatCurrency(aiQuote.materials.furniture)}</span>
                      </div>
                    )}
                    {aiQuote.materials?.other > 0 && (
                      <div className="breakdown-item">
                        <span className="breakdown-item-label">Other</span>
                        <span className="breakdown-item-value">{formatCurrency(aiQuote.materials.other)}</span>
                      </div>
                    )}
                    <div className="breakdown-item breakdown-subtotal">
                      <span className="breakdown-item-label">Subtotal</span>
                      <span className="breakdown-item-value">{formatCurrency(aiQuote.materials?.subtotal)}</span>
                    </div>
                  </div>

                  <div className="breakdown-card">
                    <div className="breakdown-title">Services</div>
                    <div className="breakdown-item">
                      <span className="breakdown-item-label">Design & PM</span>
                      <span className="breakdown-item-value">{formatCurrency(aiQuote.services?.design_pm)}</span>
                    </div>
                    <div className="breakdown-item">
                      <span className="breakdown-item-label">Install & Dismantle</span>
                      <span className="breakdown-item-value">{formatCurrency(aiQuote.services?.install_dismantle)}</span>
                    </div>
                    <div className="breakdown-item">
                      <span className="breakdown-item-label">Logistics</span>
                      <span className="breakdown-item-value">{formatCurrency(aiQuote.services?.logistics)}</span>
                    </div>
                    <div className="breakdown-item breakdown-subtotal">
                      <span className="breakdown-item-label">Subtotal</span>
                      <span className="breakdown-item-value">{formatCurrency(aiQuote.services?.subtotal)}</span>
                    </div>
                  </div>
                </div>

                <div style={{ marginTop: 24 }}>
                  {aiQuote.contingency > 0 && (
                    <div className="summary-row">
                      <span>Contingency</span>
                      <span>{formatCurrency(aiQuote.contingency)}</span>
                    </div>
                  )}
                  <div className="summary-row">
                    <span>Subtotal</span>
                    <span>{formatCurrency(aiQuote.subtotal_before_tax)}</span>
                  </div>
                  <div className="summary-row">
                    <span>Tax ({((aiQuote.tax_rate || 0) * 100).toFixed(2)}%)</span>
                    <span>{formatCurrency(aiQuote.tax_amount)}</span>
                  </div>
                  <div className="summary-row total">
                    <span>Total</span>
                    <span>{formatCurrency(aiQuote.total)}</span>
                  </div>
                </div>

                {aiQuote.notes && aiQuote.notes.length > 0 && (
                  <div className="notes-section">
                    <div className="notes-title">Notes & Assumptions</div>
                    <ul className="notes-list">
                      {aiQuote.notes.map((note, i) => <li key={i}>{note}</li>)}
                    </ul>
                  </div>
                )}
              </div>

              <button className="btn-secondary" onClick={downloadQuote} style={{ marginTop: 24 }}>
                Download Quote
              </button>
            </div>
          )}

          {/* Template Estimates (Collapsible) */}
          {estimates && (
            <div className="card">
              <div className="collapsible-header" onClick={() => setShowTemplates(!showTemplates)}>
                <h3>Quick Estimates</h3>
                <span className={`collapsible-toggle ${showTemplates ? 'open' : ''}`}>â–¼</span>
              </div>
              <div className={`collapsible-content ${showTemplates ? 'open' : ''}`}>
                <div className="template-estimates">
                  <div className="template-card budget">
                    <div className="template-tier">Budget</div>
                    <div className="template-total">{formatCurrency(estimates.aggressive.total)}</div>
                  </div>
                  <div className="template-card standard">
                    <div className="template-tier">Standard</div>
                    <div className="template-total">{formatCurrency(estimates.middle.total)}</div>
                  </div>
                  <div className="template-card premium">
                    <div className="template-tier">Premium</div>
                    <div className="template-total">{formatCurrency(estimates.conservative.total)}</div>
                  </div>
                </div>
                <p style={{ fontSize: 13, color: '#86868b', textAlign: 'center' }}>
                  Template-based estimates. Use AI Quote for detailed, calibrated pricing.
                </p>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<BoothIQ />, document.getElementById('root'));
  </script>
</body>
</html>
